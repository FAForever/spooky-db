name: Generate blueprint data

on:
    workflow_dispatch:

jobs:
    generate:
        name: Generate
        permissions: write-all
        runs-on: ubuntu-latest
        steps:
            - name: Checkout spooky db code
              uses: actions/checkout@v4
              with: # todo: remove when done
                  ref: feature/generate-workflow-setup-02 # todo: remove when done

            - name: Checkout FAForever blueprints and lua files
              uses: actions/checkout@v4
              with:
                  repository: FAForever/fa
                  path: fa
                  sparse-checkout-cone-mode: false
                  sparse-checkout: |
                      *.bp
                      *.lua

            - name: Checkout Nomads blueprints and lua files
              uses: actions/checkout@v4
              with:
                  repository: FAForever/nomads
                  path: nomads
                  sparse-checkout-cone-mode: false
                  sparse-checkout: |
                      *.bp

            # Prepare the Lua context

            - name: Install Lua
              uses: leafo/gh-actions-lua@v10
              with: 
                luaVersion: "5.1.5"

            - uses: leafo/gh-actions-luarocks@v4

            - name: Install JSON module for Lua
              run: luarocks install dkjson

            # Prepare the script context

            - name: Prepare for the script
              shell: bash
              run: |
                  mkdir tools/temp
                  mkdir tools/temp/units
                  mkdir tools/temp/lua

                  mv -f fa/units/* tools/temp/units
                  mv -f nomads/units/* tools/temp/units
                  mv fa/lua/version.lua tools/temp/lua/version.lua

                  ls -asR tools/temp/lua

            - name: Run the script
              shell: pwsh
              working-directory: tools  # script expects this directory
              run: |
                  lua -v
                  pwsh ./index.ps1 -target ../app -inputUnits "temp/units" -inputLua "temp/lua"

            - name: Add the generated file as an artifact
              uses: actions/upload-artifact@v4
              with:
                name: generated-blueprint-information.json
                path: |
                  app/data/index.json
