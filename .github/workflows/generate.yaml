name: Generate blueprint data

on:
    workflow_dispatch:

jobs:
    generate:
        name: Generate
        runs-on: ubuntu-latest
        steps:
            - uses: ilammy/msvc-dev-cmd@v1

            - name: Install Lua
              uses: leafo/gh-actions-lua@v10

            - name: Checks and balances
              shell: bash
              run: |
                  lua -v
                  python -v
                  pwsh -v
                  git -v
                  echo "$(which lua)" >> $GITHUB_PATH 
                  echo $GITHUB_PATH

            - name: Checkout spooky db code
              uses: actions/checkout@v4
              with: # todo: remove when done
                  ref: feature/generate-workflow-setup-02 # todo: remove when done

            - name: Checkout FAForever blueprints and lua files
              uses: actions/checkout@v4
              with:
                  repository: FAForever/fa
                  path: fa
                  sparse-checkout-cone-mode: false
                  sparse-checkout: |
                      *.bp
                      *.lua

            - name: Checkout Nomads blueprints and lua files
              uses: actions/checkout@v4
              with:
                  repository: FAForever/nomads
                  path: nomads
                  sparse-checkout-cone-mode: false
                  sparse-checkout: |
                      *.bp

            - name: Prepare for the script
              shell: bash
              run: |
                  #!/bin/bash
                  mkdir temp
                  mkdir temp/units
                  mkdir temp/lua

                  mv -f fa/units/* temp/units
                  mv -f nomads/units/* temp/units
                  mv fa/lua/version.lua temp/lua/version.lua

                  cd tools
                  ./generate.sh "../temp/units" "../temp/Lua"

            - name: Run the script
              shell: bash
              working-directory: tools
              run: |
                  lua -v

